<script lang="ts">
	import NetworkPrompt from '$lib/components/prompts/NetworkPrompt.svelte';
	import { getReceiverStakingDataFromSubgraph } from '$lib/controllers/subgraphController';
	import {
		allowedChainsStore,
		chainIdHasChanged,
		chainStore,
		setAllowedChainsStore
	} from '$lib/data-stores/chainProviderStore';
	import { environment } from '$lib/data-stores/environment';
	import { initializeReceiverStakingStore } from '$lib/data-stores/receiverStakingStore';
	import {
		connected,
		walletAddressHasChanged,
		walletStore
	} from '$lib/data-stores/walletProviderStore';
	import StakeDashboard from '$lib/page-components/receiver-staking/StakeDashboard.svelte';
	import type { Address } from '$lib/types/storeTypes';
	import { modifyReceiverStakingData } from '$lib/utils/data-modifiers/subgraphModifier';
	import { onDestroy, onMount } from 'svelte';

	onMount(() => {
		setAllowedChainsStore(environment.supported_chains.receiver_staking);
	});

	let previousWalletAddress: Address = '';
	let previousChainId: number | null = null;

	async function getAndSetReceiverStakingData(address: string) {
		const receiverStakingDataFromSubgraph = await getReceiverStakingDataFromSubgraph(address);
		const modifiedReceiverStakingData = modifyReceiverStakingData(receiverStakingDataFromSubgraph);
		initializeReceiverStakingStore(modifiedReceiverStakingData);
	}

	$: chainSupported = $chainStore.chainId
		? $allowedChainsStore.includes($chainStore.chainId)
		: true;

	$: if ($connected) {
		if (
			walletAddressHasChanged($walletStore.address, previousWalletAddress) ||
			chainIdHasChanged($chainStore.chainId, previousChainId)
		) {
			getAndSetReceiverStakingData($walletStore.address);
			previousChainId = $chainStore.chainId;
			previousWalletAddress = $walletStore.address;
		}
	} else {
		// resetting chain id since everything depends on the wallet address in inventory
		previousChainId = null;
		previousWalletAddress = '';
	}

	onDestroy(() => {
		setAllowedChainsStore([]);
	});
</script>

{#if chainSupported}
	<StakeDashboard />
{:else}
	<NetworkPrompt />
{/if}
